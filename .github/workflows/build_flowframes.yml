name: Build Flowframes (Public Nightly)

on:
  workflow_dispatch:

permissions:
  contents: write # REQUIRED to create releases

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. Get Code
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. Setup MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 3. Setup NuGet
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    # 4. Restore Dependencies
    - name: Restore NuGet Packages
      run: nuget restore CodeLegacy/Flowframes.sln

    # 5. SET VERSION TO 1.42.0
    - name: Set Custom Version
      shell: powershell
      run: |
        $newVersion = "1.42.0"
        Write-Host "Forcing Flowframes version to: $newVersion"
        $assemblyInfo = "CodeLegacy/Properties/AssemblyInfo.cs"
        $content = Get-Content $assemblyInfo
        $content = $content -replace 'AssemblyVersion\(".*?"\)', "AssemblyVersion(""$newVersion"")"
        $content = $content -replace 'AssemblyFileVersion\(".*?"\)', "AssemblyFileVersion(""$newVersion"")"
        Set-Content $assemblyInfo $content

    # 6. Compile (x64 Release)
    - name: Build Solution
      run: msbuild CodeLegacy/Flowframes.sln /p:Configuration=Release /p:Platform=x64

    # 7. Install Dependencies (Fast Mode)
    - name: Install AI and Video Engines
      shell: powershell
      run: |
        $ProgressPreference = 'SilentlyContinue'
        $baseDir = "CodeLegacy/bin/x64/Release"
        $pkgDir = "$baseDir/FlowframesData/pkgs"
        
        # --- RIFE ---
        Write-Host "Downloading RIFE..."
        Invoke-WebRequest -Uri "https://github.com/nihui/rife-ncnn-vulkan/releases/download/20221029/rife-ncnn-vulkan-20221029-windows.zip" -OutFile "rife.zip"
        Expand-Archive -Path "rife.zip" -DestinationPath "extracted_rife"
        
        $rifeDest = "$pkgDir/rife-ncnn-vulkan"
        New-Item -ItemType Directory -Force -Path $rifeDest
        Copy-Item -Path "extracted_rife/rife-ncnn-vulkan-20221029-windows/*" -Destination $rifeDest -Recurse
        Set-Content -Path "$rifeDest/models.json" -Value '{ "version": 1, "models": [ { "id": "rife-v4.6", "name": "RIFE 4.6", "path": "rife-v4.6" } ] }'

        # --- FFMPEG ---
        Write-Host "Downloading FFmpeg..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
        
        $avDest = "$pkgDir/av"
        New-Item -ItemType Directory -Force -Path $avDest
        $binFolder = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Directory | Where-Object { $_.Name -eq "bin" } | Select-Object -First 1
        Copy-Item -Path "$($binFolder.FullName)/*.exe" -Destination $avDest

    # 8. ZIP IT UP
    - name: Create Zip Archive
      shell: powershell
      run: |
        Compress-Archive -Path CodeLegacy/bin/x64/Release/* -DestinationPath Flowframes-Nightly.zip

    # 9. PUBLISH "NIGHTLY" RELEASE
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        name: Nightly Build (v1.42.0)
        tag_name: nightly
        files: Flowframes-Nightly.zip
        prerelease: true
        overwrite: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
